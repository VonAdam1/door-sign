<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Door Sign">
    
    <title>Door Sign PRO</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/ical.js@1.5.0/build/ical.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); } 50% { box-shadow: 0 0 60px rgba(139, 92, 246, 0.9); } }
        @keyframes pulse-orange { 0%, 100% { background-color: #f97316; } 50% { background-color: #ea580c; } }
        @keyframes party-mode { 0% { background-color: #db2777; } 50% { background-color: #9333ea; } 100% { background-color: #db2777; } }
        @keyframes ocean-breeze { 0% { background-color: #0891b2; } 50% { background-color: #0d9488; } 100% { background-color: #0891b2; } }
        @keyframes fever-pulse { 0% { background-color: #65a30d; } 50% { background-color: #3f6212; } 100% { background-color: #65a30d; } }
        @keyframes focus-breathe { 0% { background-color: #312e81; } 50% { background-color: #4338ca; } 100% { background-color: #312e81; } }
        
        .flow-mode { animation: pulse-glow 3s infinite; }
        .upcoming-mode { animation: pulse-orange 2s infinite; }
        .weekend-bg { animation: party-mode 10s infinite; }
        .vacation-bg { animation: ocean-breeze 8s infinite; }
        .sick-bg { animation: fever-pulse 4s infinite; }
        .focus-calendar-bg { animation: focus-breathe 6s infinite; }
        
        /* Förhindra markering av text och gummiband-effekt på iOS */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            overflow: hidden; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        .status-transition { transition: background-color 0.4s ease, color 0.4s ease; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen w-screen overflow-hidden">

    <div id="app" class="h-full w-full relative">

        <div v-if="isAdmin" class="h-full w-full bg-slate-50 text-slate-900 p-6 overflow-y-auto">
            <div class="max-w-4xl mx-auto pb-20"> <header class="mb-6 flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div>
                        <h1 class="text-2xl font-black text-slate-800 tracking-tight">SYSTEM CONTROL</h1>
                        <p class="text-slate-500 font-medium">Global Overrides & Triggers</p>
                    </div>
                    <div class="flex items-center gap-3 bg-slate-100 px-4 py-2 rounded-full">
                        <div :class="dbConnected ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full animate-pulse"></div>
                        <span class="text-sm font-bold uppercase tracking-widest">{{ dbConnected ? 'Live' : 'Offline' }}</span>
                    </div>
                </header>

                <section class="mb-8">
                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">Global Status Override</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                        <button @click="setStatus('auto')" :class="state.status === 'auto' ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-robot block text-xl mb-2"></i> AUTO
                        </button>
                        <button @click="setStatus('home')" :class="state.status === 'home' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-house-laptop block text-xl mb-2"></i> HOME
                        </button>
                        <button @click="setStatus('busy')" :class="state.status === 'busy' ? 'bg-red-600 text-white shadow-lg shadow-red-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-hand-paper block text-xl mb-2"></i> BUSY
                        </button>
                        <button @click="setStatus('flow')" :class="state.status === 'flow' ? 'bg-purple-600 text-white shadow-lg shadow-purple-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-brain block text-xl mb-2"></i> FLOW
                        </button>
                        <button @click="setStatus('lunch')" :class="state.status === 'lunch' ? 'bg-orange-500 text-white shadow-lg shadow-orange-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-utensils block text-xl mb-2"></i> LUNCH
                        </button>
                        <button @click="setStatus('vacation')" :class="state.status === 'vacation' ? 'bg-teal-600 text-white shadow-lg shadow-teal-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-plane block text-xl mb-2"></i> VACATION
                        </button>
                        <button @click="setStatus('sick')" :class="state.status === 'sick' ? 'bg-lime-600 text-white shadow-lg shadow-lime-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-thermometer-three-quarters block text-xl mb-2"></i> SICK
                        </button>
                    </div>
                </section>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-bolt text-yellow-500"></i> Automation Triggers
                        </h3>
                        <div class="space-y-3">
                            <button @click="triggerAction('test_notification')" class="w-full bg-slate-800 text-white p-4 rounded-xl font-bold hover:bg-slate-700 transition flex justify-between items-center">
                                <span>Skicka Test-Notis</span>
                                <i class="fas fa-bell"></i>
                            </button>
                            <button @click="triggerAction('reset_system')" class="w-full border-2 border-red-100 text-red-600 p-4 rounded-xl font-bold hover:bg-red-50 transition flex justify-between items-center">
                                <span>Nollställ allt (Daily Reset)</span>
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-calendar text-blue-500"></i> Calendar Sync
                        </h3>
                        <input type="text" v-model="state.calendarUrl" @change="saveToFirebase" class="w-full p-3 border rounded-lg bg-slate-50 font-mono text-xs mb-4" placeholder="iCal URL">
                        <div class="text-xs text-slate-400">
                            Senaste synk: {{ currentTime }}
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mt-6">
                    <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-moon text-indigo-500"></i> Nattläge (Dark Mode)
                    </h3>
                    <div class="flex gap-4">
                        <div class="w-1/2">
                            <label class="text-xs font-bold text-slate-400 uppercase">Startar</label>
                            <input type="time" v-model="state.darkModeStart" @change="saveToFirebase" class="w-full p-3 border rounded-lg bg-slate-50 font-mono">
                        </div>
                        <div class="w-1/2">
                            <label class="text-xs font-bold text-slate-400 uppercase">Slutar</label>
                            <input type="time" v-model="state.darkModeEnd" @change="saveToFirebase" class="w-full p-3 border rounded-lg bg-slate-50 font-mono">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else class="h-full w-full relative overflow-hidden" @click="activateWakeLock">
            <div class="h-full flex flex-col items-center justify-center p-4 text-center relative status-transition" :class="displayClasses">
                
                <div v-if="weather" class="absolute top-6 right-6 z-50 flex flex-col items-end opacity-90 drop-shadow-md transition-opacity duration-1000">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl md:text-5xl font-bold">{{ Math.round(weather.temperature) }}°</span>
                        <i :class="weatherIcon" class="text-3xl md:text-5xl"></i>
                    </div>
                    <span class="text-xs md:text-sm font-medium opacity-70 mt-1 uppercase tracking-widest">Odenplan</span>
                </div>

                <div class="z-10 flex flex-col items-center w-full max-w-6xl justify-center flex-grow">
                    <i :class="currentStatusIcon" class="text-[25vw] md:text-[15vw] mb-4 md:mb-8 drop-shadow-2xl opacity-90 transition-all duration-700"></i>
                    
                    <h1 class="font-black tracking-tighter drop-shadow-lg mb-2 uppercase leading-none transition-all duration-300 text-[22vw] md:text-[16vw]">
                        {{ currentStatusText }}
                    </h1>

                    <h2 class="text-2xl md:text-5xl font-bold opacity-80 mb-8 drop-shadow-md px-4">
                        {{ currentDescriptionText }}
                    </h2>
                    
                    <div class="min-h-[4rem] flex items-center justify-center w-full">
                        <p v-if="currentSubText" class="text-xl md:text-4xl font-mono font-bold opacity-100 bg-white/10 px-8 py-3 rounded-full backdrop-blur-md border border-white/20">
                            {{ currentSubText }}
                        </p>
                    </div>
                </div>

                <div class="absolute bottom-6 w-full text-center opacity-40 pointer-events-none">
                    <p class="text-xl md:text-3xl font-mono tracking-[0.5em]">{{ currentTime }}</p>
                </div>

                <div v-if="!wakeLockActive" class="absolute top-0 left-0 w-full h-full z-[100] cursor-pointer" @click="activateWakeLock" title="Klicka för att aktivera helskärmsläge"></div>

                <div v-if="computedStatus === 'flow' && !isDarkModeActive" class="absolute inset-0 flow-mode pointer-events-none border-[20px] md:border-[30px] border-purple-400/20"></div>
                <div v-if="computedStatus === 'focus_calendar' && !isDarkModeActive" class="absolute inset-0 focus-calendar-bg pointer-events-none border-[20px] md:border-[30px] border-indigo-400/20"></div>
            </div>
        </div>

    </div>
    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        const firebaseConfig = {
            apiKey: "AIzaSyCNyXnQ_yKvfY907Lb_UjBJWDqBRXEGI9w",
            authDomain: "doorsign-24670.firebaseapp.com",
            projectId: "doorsign-24670",
            storageBucket: "doorsign-24670.firebasestorage.app",
            messagingSenderId: "667405905639",
            appId: "1:667405905639:web:97742774ed5b1faec83c42"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        createApp({
            setup() {
                const isAdmin = ref(false);
                const dbConnected = ref(false);
                const now = ref(new Date());
                const calendarEvents = ref([]);
                const weather = ref(null);
                const wakeLockActive = ref(false);
                
                const state = ref({
                    status: 'auto', 
                    calendarUrl: '',
                    lastAction: '',
                    darkModeStart: '22:00',
                    darkModeEnd: '06:00'
                });

                // --- WAKE LOCK LOGIC (Håll skärmen tänd) ---
                async function activateWakeLock() {
                    if ('wakeLock' in navigator) {
                        try {
                            const lock = await navigator.wakeLock.request('screen');
                            wakeLockActive.value = true;
                            console.log("Wake Lock is active!");
                            lock.addEventListener('release', () => {
                                wakeLockActive.value = false;
                                console.log('Wake Lock released');
                            });
                        } catch (err) {
                            console.error(`${err.name}, ${err.message}`);
                        }
                    }
                }

                // --- VÄDER ---
                const weatherIcon = computed(() => {
                    if (!weather.value) return 'fas fa-cloud';
                    const code = weather.value.weathercode;
                    if (code <= 1) return 'fas fa-sun';
                    if (code <= 3) return 'fas fa-cloud-sun';
                    if (code <= 48) return 'fas fa-smog';
                    if (code <= 67) return 'fas fa-cloud-rain';
                    if (code <= 77) return 'fas fa-snowflake';
                    if (code <= 82) return 'fas fa-cloud-showers-heavy';
                    if (code <= 99) return 'fas fa-bolt';
                    return 'fas fa-cloud';
                });

                async function fetchWeather() {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=59.3426&longitude=18.0549&current_weather=true');
                        const data = await res.json();
                        weather.value = data.current_weather;
                    } catch (e) { console.log("Väder kunde inte hämtas"); }
                }

                // --- NATT-LÄGE ---
                const isDarkModeActive = computed(() => {
                    if (!state.value.darkModeStart || !state.value.darkModeEnd) return false;
                    const nowMinutes = now.value.getHours() * 60 + now.value.getMinutes();
                    const [sh, sm] = state.value.darkModeStart.split(':').map(Number);
                    const startMinutes = sh * 60 + sm;
                    const [eh, em] = state.value.darkModeEnd.split(':').map(Number);
                    const endMinutes = eh * 60 + em;

                    if (startMinutes < endMinutes) return nowMinutes >= startMinutes && nowMinutes < endMinutes;
                    else return nowMinutes >= startMinutes || nowMinutes < endMinutes;
                });

                // --- STATUS LOGIK (HÄR ÄR ÄNDRINGEN FÖR FOCUS TIME) ---
                const computedStatus = computed(() => {
                    // 1. Manuell override går alltid först
                    if (state.value.status !== 'auto') return state.value.status;
                    
                    // 2. Helg-check
                    const day = now.value.getDay();
                    if (day === 0 || day === 6) return 'weekend';
                    
                    const t = now.value.getTime();
                    
                    // 3. Kolla pågående event
                    // 3. Kolla pågående event
const currentEvent = calendarEvents.value.find(e => t >= e.startDate.getTime() && t < e.endDate.getTime());

if (currentEvent) {
    const title = (currentEvent.summary || "").toLowerCase();
    
    // Vi kollar efter dina specifika titlar här
    const shouldShowFocus = title.includes("head of post") || 
                           title.includes("cto") || 
                           title.includes("focus") || 
                           title.includes("fokus");

    if (shouldShowFocus) {
        return 'focus_calendar'; // Visar din snygga FOCUS-skärm
    }
    
    return 'busy'; // För alla andra möten
}
                    
                    // 4. Kolla kommande event (inom 10 min)
                    const upcomingEvent = calendarEvents.value.find(e => {
                        const timeUntil = e.startDate.getTime() - t;
                        return timeUntil > 0 && timeUntil <= 600000;
                    });
                    
                    if (upcomingEvent) return 'upcoming';
                    
                    // 5. Annars ledigt
                    return 'free';
                });

                // --- UI MAPPINGS (FÄRG OCH TEXT) ---
                const displayClasses = computed(() => {
                    if (isDarkModeActive.value) return 'bg-black text-gray-400';
                    switch (computedStatus.value) {
                        case 'home': return 'bg-indigo-800';
                        case 'busy': return 'bg-red-600';
                        case 'focus_calendar': return 'bg-indigo-950'; // Mörkare bakgrund för fokusläget
                        case 'upcoming': return 'upcoming-mode';
                        case 'flow': return 'bg-purple-950';
                        case 'lunch': return 'bg-orange-500';
                        case 'free': return 'bg-emerald-600';
                        case 'weekend': return 'weekend-bg';
                        case 'vacation': return 'vacation-bg';
                        case 'sick': return 'sick-bg';
                        default: return 'bg-slate-900';
                    }
                });

                const currentStatusText = computed(() => {
                    if (isDarkModeActive.value) return 'ZZZ...';
                    switch (computedStatus.value) {
                        case 'home': return 'HOME';
                        case 'busy': return 'BUSY';
                        case 'focus_calendar': return 'FOCUS MODE'; // Din nya text
                        case 'upcoming': return 'SOON';
                        case 'flow': return 'FOCUS'; // Manuell Focus (knappen)
                        case 'lunch': return 'LUNCH';
                        case 'free': return 'FREE';
                        case 'weekend': return 'WEEKEND';
                        case 'vacation': return 'SEMESTER';
                        case 'sick': return 'SICK';
                        default: return 'SYNC';
                    }
                });

                const currentDescriptionText = computed(() => {
                    if (isDarkModeActive.value) return 'Sov gott';
                    if (computedStatus.value === 'home') return "I'm Working from home";
                    if (computedStatus.value === 'busy') return "I'm in a meeting";
                    
                    // HÄR ÄR DIN SPECIFIKA TEXT FÖR KALENDER-FOCUS
                    if (computedStatus.value === 'focus_calendar') return "Please do not disturb unless it is urgent";
                    
                    if (computedStatus.value === 'upcoming') return "Meeting starts shortly";
                    if (computedStatus.value === 'flow') return "Deep work in progress"; // Text för manuell knapp
                    if (computedStatus.value === 'lunch') return "Out for lunch";
                    if (computedStatus.value === 'weekend') return "What are you doing here?";
                    if (computedStatus.value === 'vacation') return "Off Duty";
                    if (computedStatus.value === 'sick') return "Out sick";
                    return "Available";
                });

                const currentSubText = computed(() => {
                    if (isDarkModeActive.value) return '';
                    if (computedStatus.value === 'home') return 'Available on ClickUp & Mail';
                    if (computedStatus.value === 'weekend') return 'Go home!';
                    if (computedStatus.value === 'vacation') return "Don't call me";
                    if (computedStatus.value === 'sick') return 'Trying to rest';
                    
                    // Visa sluttid även för Focus Time
                    const t = now.value.getTime();
                    const current = calendarEvents.value.find(e => t >= e.startDate.getTime() && t < e.endDate.getTime());
                    if (current) return `Ends ${current.endDate.toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'})}`;
                    
                    return '';
                });

                const currentStatusIcon = computed(() => {
                    if (isDarkModeActive.value) return 'fas fa-moon';
                    switch (computedStatus.value) {
                        case 'home': return 'fas fa-house-laptop';
                        case 'busy': return 'fas fa-door-closed';
                        case 'focus_calendar': return 'fas fa-brain'; // Hjärn-ikonen för Focus Time
                        case 'upcoming': return 'fas fa-hourglass-half';
                        case 'flow': return 'fas fa-headphones';
                        case 'lunch': return 'fas fa-utensils';
                        case 'free': return 'fas fa-door-open';
                        case 'weekend': return 'fas fa-glass-cheers';
                        case 'vacation': return 'fas fa-umbrella-beach';
                        case 'sick': return 'fas fa-thermometer-three-quarters';
                        default: return 'fas fa-sync fa-spin';
                    }
                });

                const currentTime = computed(() => now.value.toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit', second:'2-digit'}));

                function setStatus(newStatus) {
                    state.value.status = newStatus;
                    saveToFirebase();
                }

                function triggerAction(actionName) {
                    state.value.lastAction = actionName + "_" + Date.now();
                    saveToFirebase();
                    alert("Kommando skickat till Home Assistant: " + actionName);
                }

                function saveToFirebase() {
                    db.collection("doorsign").doc("settings").set(state.value)
                        .then(() => dbConnected.value = true)
                        .catch(err => console.error(err));
                }

                async function fetchCalendar() {
                    if (!state.value.calendarUrl) return;
                    try {
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(state.value.calendarUrl + '?t=' + Date.now())}`;
                        const res = await fetch(proxyUrl);
                        const text = await res.text();
                        const jcal = ICAL.parse(text);
                        const comp = new ICAL.Component(jcal);
                        calendarEvents.value = comp.getAllSubcomponents('vevent').map(ve => {
                            const ev = new ICAL.Event(ve);
                            return { summary: ev.summary, startDate: ev.startDate.toJSDate(), endDate: ev.endDate.toJSDate() };
                        }).filter(e => e.endDate > new Date());
                    } catch (e) { console.log("Calendar sync..."); }
                }

                onMounted(() => {
                    isAdmin.value = new URLSearchParams(window.location.search).get('mode') === 'admin';
                    
                    db.collection("doorsign").doc("settings").onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            state.value = { ...state.value, ...data };
                            dbConnected.value = true;
                            fetchCalendar();
                        }
                    });

                    setInterval(() => now.value = new Date(), 1000);
                    setInterval(fetchCalendar, 60000);
                    
                    fetchWeather();
                    setInterval(fetchWeather, 900000);
                });

                return { 
                    isAdmin, state, dbConnected, computedStatus, 
                    displayClasses, currentStatusText, currentDescriptionText, 
                    currentSubText, currentStatusIcon, currentTime, 
                    weather, weatherIcon, isDarkModeActive, wakeLockActive,
                    setStatus, triggerAction, saveToFirebase, activateWakeLock 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>