<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Door Sign PRO - Admin Control</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/ical.js@1.5.0/build/ical.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); } 50% { box-shadow: 0 0 60px rgba(139, 92, 246, 0.9); } }
        @keyframes pulse-orange { 0%, 100% { background-color: #f97316; } 50% { background-color: #ea580c; } }
        .flow-mode { animation: pulse-glow 3s infinite; }
        .upcoming-mode { animation: pulse-orange 2s infinite; }
        body { font-family: 'Segoe UI', sans-serif; overflow: hidden; user-select: none; }
        .status-transition { transition: background-color 0.4s ease; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen w-screen">

    <div id="app" class="h-full w-full relative">

        <div v-if="isAdmin" class="h-full w-full bg-slate-50 text-slate-900 p-6 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <header class="mb-6 flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div>
                        <h1 class="text-2xl font-black text-slate-800 tracking-tight">SYSTEM CONTROL</h1>
                        <p class="text-slate-500 font-medium">Global Overrides & Triggers</p>
                    </div>
                    <div class="flex items-center gap-3 bg-slate-100 px-4 py-2 rounded-full">
                        <div :class="dbConnected ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full animate-pulse"></div>
                        <span class="text-sm font-bold uppercase tracking-widest">{{ dbConnected ? 'Live' : 'Offline' }}</span>
                    </div>
                </header>

                <section class="mb-8">
                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">Global Status Override</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <button @click="setStatus('auto')" :class="state.status === 'auto' ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-robot block text-xl mb-2"></i> AUTO
                        </button>
                        <button @click="setStatus('home')" :class="state.status === 'home' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-house-laptop block text-xl mb-2"></i> HOME
                        </button>
                        <button @click="setStatus('busy')" :class="state.status === 'busy' ? 'bg-red-600 text-white shadow-lg shadow-red-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-hand-paper block text-xl mb-2"></i> BUSY
                        </button>
                        <button @click="setStatus('flow')" :class="state.status === 'flow' ? 'bg-purple-600 text-white shadow-lg shadow-purple-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-brain block text-xl mb-2"></i> FLOW
                        </button>
                        <button @click="setStatus('lunch')" :class="state.status === 'lunch' ? 'bg-orange-500 text-white shadow-lg shadow-orange-200' : 'bg-white text-slate-600'" class="p-4 rounded-xl font-bold transition-all border border-slate-200">
                            <i class="fas fa-utensils block text-xl mb-2"></i> LUNCH
                        </button>
                    </div>
                </section>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-bolt text-yellow-500"></i> Automation Triggers
                        </h3>
                        <div class="space-y-3">
                            <button @click="triggerAction('test_notification')" class="w-full bg-slate-800 text-white p-4 rounded-xl font-bold hover:bg-slate-700 transition flex justify-between items-center">
                                <span>Skicka Test-Notis</span>
                                <i class="fas fa-bell"></i>
                            </button>
                            <button @click="triggerAction('reset_system')" class="w-full border-2 border-red-100 text-red-600 p-4 rounded-xl font-bold hover:bg-red-50 transition flex justify-between items-center">
                                <span>Nollställ allt (Daily Reset)</span>
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-calendar text-blue-500"></i> Calendar Sync
                        </h3>
                        <input type="text" v-model="state.calendarUrl" @change="saveToFirebase" class="w-full p-3 border rounded-lg bg-slate-50 font-mono text-xs mb-4" placeholder="iCal URL">
                        <div class="text-xs text-slate-400">
                            Senaste synk: {{ currentTime }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else class="h-full w-full relative">
            <div class="h-full flex flex-col items-center justify-center p-8 text-center relative status-transition" :class="displayClasses">
                
                <div class="z-10 flex flex-col items-center w-full max-w-4xl">
                    <i :class="currentStatusIcon" class="text-9xl mb-8 drop-shadow-2xl opacity-90 transition-all duration-700"></i>
                    
                    <h1 class="font-black tracking-tighter drop-shadow-lg mb-2 uppercase leading-none transition-all duration-300 text-8xl md:text-[12rem]">
                        {{ currentStatusText }}
                    </h1>

                    <h2 class="text-4xl md:text-6xl font-bold opacity-80 mb-10 drop-shadow-md">
                        {{ currentDescriptionText }}
                    </h2>
                    
                    <div class="min-h-[5rem] flex items-center justify-center w-full">
                        <p v-if="currentSubText" class="text-3xl md:text-5xl font-mono font-bold opacity-100 bg-white/10 px-12 py-4 rounded-full backdrop-blur-md border border-white/20">
                            {{ currentSubText }}
                        </p>
                    </div>
                </div>

                <div class="absolute bottom-10 w-full text-center opacity-40 pointer-events-none">
                    <p class="text-3xl font-mono tracking-[0.5em]">{{ currentTime }}</p>
                </div>

                <div v-if="computedStatus === 'flow'" class="absolute inset-0 flow-mode pointer-events-none border-[30px] border-purple-400/20"></div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        const firebaseConfig = {
            apiKey: "AIzaSyCNyXnQ_yKvfY907Lb_UjBJWDqBRXEGI9w",
            authDomain: "doorsign-24670.firebaseapp.com",
            projectId: "doorsign-24670",
            storageBucket: "doorsign-24670.firebasestorage.app",
            messagingSenderId: "667405905639",
            appId: "1:667405905639:web:97742774ed5b1faec83c42"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        createApp({
            setup() {
                const isAdmin = ref(false);
                const dbConnected = ref(false);
                const now = ref(new Date());
                const calendarEvents = ref([]);
                
                const state = ref({
                    status: 'auto', 
                    calendarUrl: '',
                    lastAction: '' // Används för att skicka kommandon till HA
                });

                // --- LOGIK-HUVUDREGEL: HOME TRUMFAR ALLT ---
                const computedStatus = computed(() => {
                    // 1. Om Adam satt status till 'HOME', stanna där oavsett kalender.
                    if (state.value.status === 'home') return 'home';
                    
                    // 2. Om andra manuella lägen är valda (Busy, Flow, Lunch), använd dem.
                    if (state.value.status !== 'auto') return state.value.status;
                    
                    // 3. Om läget är 'AUTO', kolla kalendern.
                    const t = now.value.getTime();
                    const currentEvent = calendarEvents.value.find(e => t >= e.startDate.getTime() && t < e.endDate.getTime());
                    if (currentEvent) return 'busy';

                    const upcomingEvent = calendarEvents.value.find(e => {
                        const timeUntil = e.startDate.getTime() - t;
                        return timeUntil > 0 && timeUntil <= 600000;
                    });
                    if (upcomingEvent) return 'upcoming';

                    return 'free';
                });

                const displayClasses = computed(() => {
                    switch (computedStatus.value) {
                        case 'home': return 'bg-indigo-800';
                        case 'busy': return 'bg-red-600';
                        case 'upcoming': return 'upcoming-mode';
                        case 'flow': return 'bg-purple-950';
                        case 'lunch': return 'bg-orange-500';
                        case 'free': return 'bg-emerald-600';
                        default: return 'bg-slate-900';
                    }
                });

                const currentStatusText = computed(() => {
                    switch (computedStatus.value) {
                        case 'home': return 'HOME';
                        case 'busy': return 'BUSY';
                        case 'upcoming': return 'SOON';
                        case 'flow': return 'FOCUS';
                        case 'lunch': return 'LUNCH';
                        case 'free': return 'FREE';
                        default: return 'SYNC';
                    }
                });

                const currentDescriptionText = computed(() => {
                    if (computedStatus.value === 'home') return "Working from home";
                    if (computedStatus.value === 'busy') return "In a meeting";
                    if (computedStatus.value === 'upcoming') return "Meeting starts shortly";
                    if (computedStatus.value === 'flow') return "Deep work in progress";
                    if (computedStatus.value === 'lunch') return "Out for lunch";
                    return "Available";
                });

                const currentSubText = computed(() => {
                    if (computedStatus.value === 'home') return 'Online via Teams';
                    const t = now.value.getTime();
                    const current = calendarEvents.value.find(e => t >= e.startDate.getTime() && t < e.endDate.getTime());
                    if (current) return `Ends ${current.endDate.toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'})}`;
                    return '';
                });

                const currentStatusIcon = computed(() => {
                    switch (computedStatus.value) {
                        case 'home': return 'fas fa-house-laptop';
                        case 'busy': return 'fas fa-door-closed';
                        case 'upcoming': return 'fas fa-hourglass-half';
                        case 'flow': return 'fas fa-headphones';
                        case 'lunch': return 'fas fa-utensils';
                        case 'free': return 'fas fa-door-open';
                        default: return 'fas fa-sync fa-spin';
                    }
                });

                const currentTime = computed(() => now.value.toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit', second:'2-digit'}));

                // --- FUNKTIONER ---

                function setStatus(newStatus) {
                    state.value.status = newStatus;
                    saveToFirebase();
                }

                // NYTT: Skickar ett kommando som Home Assistant kan lyssna på
                function triggerAction(actionName) {
                    state.value.lastAction = actionName + "_" + Date.now();
                    saveToFirebase();
                    alert("Kommando skickat till Home Assistant: " + actionName);
                }

                function saveToFirebase() {
                    db.collection("doorsign").doc("settings").set(state.value)
                        .then(() => dbConnected.value = true)
                        .catch(err => console.error(err));
                }

                async function fetchCalendar() {
                    if (!state.value.calendarUrl) return;
                    try {
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(state.value.calendarUrl + '?t=' + Date.now())}`;
                        const res = await fetch(proxyUrl);
                        const text = await res.text();
                        const jcal = ICAL.parse(text);
                        const comp = new ICAL.Component(jcal);
                        calendarEvents.value = comp.getAllSubcomponents('vevent').map(ve => {
                            const ev = new ICAL.Event(ve);
                            return { summary: ev.summary, startDate: ev.startDate.toJSDate(), endDate: ev.endDate.toJSDate() };
                        }).filter(e => e.endDate > new Date());
                    } catch (e) { console.log("Calendar sync..."); }
                }

                onMounted(() => {
                    isAdmin.value = new URLSearchParams(window.location.search).get('mode') === 'admin';
                    db.collection("doorsign").doc("settings").onSnapshot(doc => {
                        if (doc.exists) {
                            state.value = doc.data();
                            dbConnected.value = true;
                            fetchCalendar();
                        }
                    });
                    setInterval(() => now.value = new Date(), 1000);
                    setInterval(fetchCalendar, 300000);
                });

                return { isAdmin, state, dbConnected, computedStatus, displayClasses, currentStatusText, currentDescriptionText, currentSubText, currentStatusIcon, currentTime, setStatus, triggerAction, saveToFirebase };
            }
        }).mount('#app');
    </script>
</body>
</html>